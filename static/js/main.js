/**
 * main.js - TTS Frontend Logic
 * Integrated with Flask backend for dynamic audio filename handling
 */

// ==================== DOM ELEMENTS ====================
const elements = {
    textInput: document.getElementById('text-input'),
    charCount: document.getElementById('char-count'),
    voiceSelect: document.getElementById('voice-select'),
    synthesizeBtn: document.getElementById('synthesize-btn'),
    clearBtn: document.getElementById('clear-btn'),
    statusSection: document.getElementById('status-section'),
    statusMessage: document.getElementById('status-message'),
    audioSection: document.getElementById('audio-section'),
    audioPlayer: document.getElementById('audio-player'),
    audioInfo: document.getElementById('audio-info'),
    downloadBtn: document.getElementById('download-btn')
};

// ==================== STATE ====================
let isGenerating = false;
let currentAudioUrl = null;

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    loadVoices();
    setupEventListeners();
});

// ==================== CORE FUNCTIONS ====================

/**
 * Fetch available voices from the backend
 */
async function loadVoices() {
    try {
        const response = await fetch('/api/voices');
        const data = await response.json();
        
        if (data.success) {
            elements.voiceSelect.innerHTML = data.voices.map(voice => 
                `<option value="${voice.id || ''}">${voice.name}</option>`
            ).join('');
        }
    } catch (error) {
        console.error('Failed to load voices:', error);
        showStatus('Could not load voices. Using system default.', 'error');
    }
}

/**
 * Handle the TTS Synthesis request
 */
async function handleSynthesize() {
    const text = elements.textInput.value.trim();
    
    if (!text) {
        showStatus('Please enter text to synthesize.', 'error');
        return;
    }

    if (isGenerating) return;

    // UI Loading State
    setLoading(true);
    hideStatus();

    try {
        const response = await fetch('/api/synthesize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: text,
                // If "Default" is selected, value is "", sent as null to backend
                voice_preset: elements.voiceSelect.value || null
            })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Synthesis failed');
        }

        // Handle the backend-generated audio URL
        currentAudioUrl = data.audio_url;
        displayResult(data);
        showStatus('âœ“ Audio generated successfully', 'success');

    } catch (error) {
        console.error('Synthesis Error:', error);
        showStatus(`Error: ${error.message}`, 'error');
    } finally {
        setLoading(false);
    }
}

/**
 * Update the UI with the result from the backend
 */
function displayResult(data) {
    // 1. Update Audio Player
    elements.audioPlayer.src = data.audio_url;
    
    // 2. Show Audio Section
    elements.audioSection.style.display = 'block';
    
    // 3. Format Metadata
    const date = new Date(data.timestamp).toLocaleTimeString();
    elements.audioInfo.innerHTML = `
        <div class="metadata-grid">
            <span><strong>ID:</strong> ${data.audio_id.substring(0, 8)}</span>
            <span><strong>Duration:</strong> ~${data.estimated_duration}s</span>
            <span><strong>Generated:</strong> ${date}</span>
        </div>
    `;

    // 4. Auto-play
    elements.audioPlayer.play().catch(e => console.log("Autoplay blocked"));
}

// ==================== UTILS & UI ====================

function setupEventListeners() {
    // Synthesis Trigger
    elements.synthesizeBtn.addEventListener('click', handleSynthesize);

    // Character Counter
    elements.textInput.addEventListener('input', () => {
        const length = elements.textInput.value.length;
        elements.charCount.textContent = length;
    });

    // Clear Button
    elements.clearBtn.addEventListener('click', () => {
        elements.textInput.value = '';
        elements.charCount.textContent = '0';
        elements.audioSection.style.display = 'none';
        elements.audioPlayer.src = '';
    });

    // Download Button (uses the URL generated by backend)
    elements.downloadBtn.addEventListener('click', () => {
        if (!currentAudioUrl) return;
        const a = document.createElement('a');
        a.href = currentAudioUrl;
        a.download = `tts-audio-${Date.now()}.wav`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });
}

function setLoading(loading) {
    isGenerating = loading;
    elements.synthesizeBtn.disabled = loading;
    elements.synthesizeBtn.textContent = loading ? 'Generating...' : 'Generate Speech';
}

function showStatus(msg, type) {
    elements.statusSection.style.display = 'block';
    elements.statusMessage.textContent = msg;
    elements.statusMessage.className = `status-message ${type}`;
}

function hideStatus() {
    elements.statusSection.style.display = 'none';
}